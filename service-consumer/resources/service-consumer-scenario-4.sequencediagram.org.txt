title Scenario 4: Full implementation, with prechecks and delegation evidence

participant "Service Consumer" as SC
participant "iSHARE Satellite" as SAT
participant "Authorization Registry" as AR
participant "Service Provider" as SP

autonumber
activate SC
SC->SC:Create JWT
SC->SAT:POST /connect/token
activate SAT
SAT->SC:Access Token (1)
deactivate SAT
SC->SAT:GET /trusted_list
activate SAT
SAT->SC: Trusted List
deactivate SAT
SC->SAT:GET /parties/<eori of service provider>
activate SAT
SAT->SC:Party
deactivate SAT
group Checks on Authorization Registry
SC->SC:Check certificate against CAs in Trusted List
SC->SC:Check certificate status (revocation, notAfter)
SC->SC:Check party status and role
end
SC->SAT:GET /parties/<eori of authorization registry>
activate SAT
SAT->SC:Party
deactivate SAT
group Checks on Authorization Registry
SC->SC:Check certificate against CAs in Trusted List
SC->SC:Check certificate status (revocation, notAfter)
SC->SC:Check party status and role
end
SC->SC:Create JWT
SC->AR:POST /connect/token
activate AR
AR->SC:Access Token (2)
deactivate AR
SC->AR:POST /delegation
activate AR
AR->SC:Delegation Evidence
deactivate AR
SC->SC:Create JWT
SC->SP:POST /connect/token
activate SP
SP->SC:Access Token (3)
deactivate SP
SC->SP:GET /capabilities
activate SP
SP->SC:Capabilities (including endpoints)
deactivate SP
SC->SP:GET/POST/... service (provide Access Token)
activate SP
SP->SC:Deliver service
deactivate SP
